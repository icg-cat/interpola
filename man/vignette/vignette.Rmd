---
title: "Package interpola vignette"
author: "Irene Cruz"
date: "`r format(Sys.time(), '%d-%m-%y')`"
output: 
  html_document:
    df_print: paged
    css: mycerulean.css
    highlight: tango
    code_folding: hide
    number_sections: true
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
editor_options: 
  chunk_output_type: console
---

![](trama.png)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F)
```

```{r eval=FALSE, include=FALSE}
# Aquest chunk insereix el logo del IM: 
htmltools::img(src = knitr::image_uri("logo.png"), 
               alt = 'logo', 
               width = 230, 
               height = 100, 
               style = 'position:absolute; 
               top:0; right:0; 
               padding:10px;')
```

```{r}
rmarkdown::includes(in_header = "trama.png")
```



```{r include = FALSE}
library(showtext)
library(tidyverse)
library(interpola)
```


```{r include = FALSE}
font_add_google(name   = "Atkinson Hyperlegible", 
                family = "Atkinson Hyperlegible")
showtext_auto()
```


# Presentació

El paquet `interpola` simplifica un seguit de tasques per la interpolació espacial de dades d'indicadors informats al nivell de la secció censal. En la seva versió actual (`r packageVersion("interpola"`), el paquet consta de 3 funcions:

* estandarditza_1(): funció per estandarditzar les dades inicials a un format que es pugui integrar posteriorment amb les dades catastrals, que són les que permeten dividir i reagrupar en altres divisions territorials
* identifica_seccionat_2(): funció que identifica l'any de seccionat de les dades inicials (que no té per què coincidir amb l'any dels indicadors informats)
* redistri_sc_3(): funció que redistribueix els indicadors d'un seccionat a un altre, ponderant per individus o per nombre d'habitatges.  

L'estat de desenvolupament actual del paquet es resumeix en aquest diagrama de procés: 

```{r, out.width="0.3\\linewidth", include=TRUE, fig.align="center", echo=FALSE}
knitr::include_graphics(here::here("data-raw/workflow.pdf"))
```


# Exemples d'ús


Posem per cas que tenim unes dades sobre mercat de treball corresponents a l'any 2021. Les tenim informades per secció censal. En aquest exemple més simple, l'any de l'indicador (taxa d'atur) i l'any del seccionat coincideixen, però podria no ser el cas. Per motius analítics, necessitem interpolar aquest indicador al seccionat de l'any 2011. Farem servir les dades de mostra contingudes al paquet per il·lustrar el procediment. 

Primer carreguem les dades, que es troben en format de llista, en tres conjunts diferents: 

* `indicador`: conté una taula amb la taxa d'atur informada per una submostra de seccions censals. Serveix també d'exemple del format (long) que cal fer servir pel procediment, on hi haurà un mínim de tres columnes o variables, sent una el seccionat, una altra l'any pel qual s'informa l'indicador, i una tercera l'indicador. 
* `cad_AMB`: conté una taula amb una submostra de parcel·les catastrals de les seccions contingudes al primer conjunt de dades. El paquet conté un conjunt de dades de mostra, consistent en la correspondència entre parcel·les catastrals i seccions censals, així com estimacions de població i nombre d'habitatges per parcel·la, pels anys 2011 i per l'interval de 2015 a 2023. Aquesta taula no està inclosa en la versió pública del paquet (a GitHub), però està inclosa a la versió local del paquet. 
* `shapes`: conté una taula amb les geometries que permeten mapejar les seccions censals contingudes a les dues taules anteriors. 

Carreguem la llista de conjunts de dades:
```{r}
data("ex_data", package = "interpola")
```

En un primer pas, podem preparar les dades d'input (l'indicador), donant a les variables noms consistents (que caldrà pel pas següent). 

* `grep_edicio`: expressió regular que ha de permetre identificar de manera única la variable que designa l'any de la dada informada o indicador. Aquesta variable passarà a dir-se "ANYO"
* `grep_seccio`: expressió regular que ha de permetre identificar de manera única la variable que designa el codi de secció censal. Aquesta variable passarà a dir-se "SECCIO"

El resultat és un dataframe amb l'indicador inicial, amb els noms estandarditzats, i sense files ni columnes buides. Altres tractaments de depuració o reestructuració de dades que puguin necessitar-se s'han de fer a banda d'aquesta funció. 

```{r}
d1 <- interpola::estandarditza_1(ex_data$indicador, grep_edicio = "ANY", grep_seccio = "SECCIO$")

d1
```


En un segon pas, identificarem el seccionat d'origen de l'indicador. Aquest pas respon al fet que sovint les dades porten informada una columna amb l'any de referència de l'indicador, i aquest no necessita correspondre's amb l'any del seccionat. D'altra banda, l'any del seccionat a vegades està informat al nom de la variable de la secció censal, però a efectes d'automatitzar processos, necessitem donar un nom uniforme a les variables de seccionat. En qualsevol cas, aquest pas és opcional. 

```{r}
(seccionat_origen <- interpola::identifica_seccionat_2(d1))
```

En darrer lloc, aplicarem la interpolació espacial de les dades. Perquè l'indicador informa una dada poblacional, farem servir la ponderació de distribució que té en compte les persones per parcel·la, en lloc del nombre d'habitatges. 

```{r}
res <- interpola::redistri_sc_3(indicador = d1[,1:3], 
                                seccionat_origen = seccionat_origen, 
                                seccionat_desti = "2011", 
                                pes = "persones")
```

L'objecte `res` conté els resultats d'interpolar les dades de la taxa d'atur de 2021 al seccionat de 2011. 

# Mapejar els resultats

Revisem els resultats obtinguts. 

